<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Product Portal â€” Select Items, Add Labor</title>
  <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="loading.css"/>
    <script src="at-options-cache.js"></script>

<script src="app-config.js"></script>
<script src="loading-indicators.js"></script>

<script src="skip-network-on-mode-switch.js"></script>

  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
</head>
<body>

  <!-- Cart button (fixed, top-right) -->
  <button id="cartFab" class="cart-fab" aria-label="Open cart">
    <span class="cart-emoji" aria-hidden="true">ðŸ›’</span>
    <span id="cartCountBadge" class="badge">0</span>
  </button>

 <h1 class="page-title">VPO</h1>

  <!-- Controls -->
  <div id="controls" class="card">
    <input id="searchInput" type="search" placeholder="Search by SKU or Descriptionâ€¦" aria-label="Search by SKU or description" disabled />
    <select id="vendorFilter" aria-label="Filter by vendor" disabled>
      <option value="">All vendors</option>
    </select>
    <select id="categoryFilter" aria-label="Filter by category" disabled>
      <option value="">All categories</option>
    </select>
    <button id="clearFilters" class="btn" disabled>Clear</button>
 <!-- Mode Toggle: place near the top of index.html where the dropdown used to be -->
<div class="mode-toggle" role="group" aria-label="App mode">
  <button type="button" class="mode-btn" data-mode="vpo"    id="modeVpo"    aria-pressed="false">VPO</button>
  <button type="button" class="mode-btn" data-mode="fillin" id="modeFillin" aria-pressed="false">Fill-In</button>
</div>

<!-- Hidden-until-filter hint -->
<p id="bg-hint" style="display:block;margin:10px 0;color:#555;font-style:italic;">
</p>
<div class="status-row" id="dataStatusRow" aria-live="polite" aria-atomic="true">
      <span id="dataStatus" class="status-pill" data-state="idle">Not loaded</span>
      <button id="refreshData" class="btn" type="button">Refresh</button>
    </div>

</div>
<div class="status-row" id="dataStatusRow" aria-live="polite" aria-atomic="true">
  <span id="dataStatus" class="status-pill" data-state="idle"></span>
  <span id="fetch-count" class="count-badge" style="margin-left:8px;"></span>
</div>

  <!-- Category chips (mobile-friendly quick filter) -->
  <div id="categoryChips" class="chips scroller hidden" aria-label="Quick category filters"></div>
  
  </section>

<!-- Virtualized table (fast for 10k+ rows) -->
<div id="table-viewport" aria-label="Products table" style="display:none;">
  <div class="vhead">
    <div>Vendor</div><div>SKU</div><div>UOM</div><div>Description</div>
   <div>QTY</div>
  </div>
  <div id="table-spacer"></div>
</div>

<!-- Toast -->
  <div id="toast" role="status" aria-live="polite">Done</div>

<!-- Loading overlay -->
<div id="loadingBarOverlay" role="status" aria-live="polite" style="display:none;">
  <div class="loading-panel" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
    <div id="loadingBarLabel" class="loading-label">Startingâ€¦</div>
    <div class="loading-track">
      <div id="loadingBar" class="loading-fill" style="width:5%"></div>
    </div>
    <div id="loadingBarMeta" class="loading-meta"></div>
  </div>
</div>

<div id="gentleModeRow" class="row-gap" style="margin:6px 0 10px 0; display:none;">
  <label style="display:inline-flex;align-items:center;gap:8px;font-size:0.9rem;">
    <input id="gentleMode" type="checkbox" checked /> Gentle mode (prevent 429s)
  </label>
</div>

<!-- ===== Description Sheet (mobile/desktop) ===== -->
<div id="desc-sheet" hidden>
  <div class="ds-backdrop"></div>
  <div class="ds-panel" role="dialog" aria-modal="true" aria-labelledby="ds-title">
    <div class="ds-header">
      <strong id="ds-title">Item</strong>
      <button id="ds-close" class="btn ds-close" aria-label="Close">âœ•</button>
    </div>

    <div class="ds-body">
      <div class="ds-row"><span class="k">Vendor</span><span class="v" id="ds-vendor">â€”</span></div>
      <div class="ds-row"><span class="k">SKU</span><span class="v" id="ds-sku">â€”</span></div>
      <div class="ds-row"><span class="k">UOM</span><span class="v" id="ds-uom">â€”</span></div>
      <div class="ds-row"><span class="k">Helper</span><span class="v" id="ds-helper">â€”</span></div>
      <div class="ds-row"><span class="k">Multiple</span><span class="v" id="ds-multiple">â€”</span></div>
      <div class="ds-row big"><span class="k">Description</span><span class="v" id="ds-desc">â€”</span></div>
      <div class="ds-row"><span class="k">Unit Price</span><span class="v" id="ds-price">â€”</span></div>
    </div>

    <form id="ds-form" class="ds-actions" autocomplete="off">
      <input id="ds-qty"
             type="text"
             inputmode="numeric"
             pattern="[0-9]*"
             aria-label="Quantity"
             placeholder="0"
             value=""
             minlength="0"
             class="ds-qty">
      <button id="ds-add" type="submit" class="btn ds-add">Add</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

<script src="database.js"></script>
<link rel="stylesheet" href="theme.pro.css"> 

<script src="app-ui-gates.js"></script>

<script>
  function __bootGoogleIfNeeded() {
    try {
      if (window.__SKIP_BOOTSTRAP) {
        console.debug("[gapi] skip boot (mode switch)");
        return;
      }
      if (typeof gapiLoaded === "function") {
        gapiLoaded(); 
      }
    } catch (e) {
      console.warn("[gapi] boot guard failed", e);
    }
  }
</script>

<script src="https://apis.google.com/js/api.js" async defer onload="__bootGoogleIfNeeded()"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>



<script>
  (function () {
    try {
      if (window.APP) {
        document.title = (window.APP.uiTitle || "Portal") + " â€” Product & VPO Calculator";
        var h1 = document.querySelector(".page-title");
        if (h1) h1.textContent = window.APP.uiTitle || h1.textContent;
      }
    } catch {}
  })();
   (function(){
    // Prefer URL ?app=..., then localStorage, then default
    const qs = new URLSearchParams(location.search);
    const qsMode = (qs.get("app")||"").toLowerCase();
    const saved  = localStorage.getItem("vanir_app_mode") || "";
    const mode   = qsMode || saved || "vpo";
    const sel = document.getElementById("appModeSelect");
    if (sel) sel.value = mode;
    if (!qsMode && mode) {
      // if no ?app, apply data-app attribute so app-config can see it on first render
      document.documentElement.setAttribute("data-app", mode);
    }
    if (sel) sel.addEventListener("change", () => {
      const next = sel.value;
      localStorage.setItem("vanir_app_mode", next);
      const url = new URL(location.href);
      url.searchParams.set("app", next);
      location.href = url.toString(); // reload with explicit mode
    });
  })();
   (function(){
    var sel = document.getElementById("appModeSelect");
    if (!sel) return;
    // Initialize the dropdown to current mode
    try { sel.value = (window.APP_MODE || "vpo"); } catch {}
    // On change, persist and reload with ?app=
    sel.addEventListener("change", function(){
      if (typeof window.__setAppMode === "function") {
        window.__setAppMode(sel.value);
      } else {
        // fallback
        try { localStorage.setItem("vanir_app_mode", sel.value); } catch {}
        var url = new URL(location.href);
        url.searchParams.set("app", sel.value);
        location.href = url.toString();
      }
    }, { passive:true });
  })();
   (function(){
    var fab = document.getElementById("cartFab");
    if (!fab) return;
    fab.addEventListener("click", function(){
      var m = window.APP_MODE || "vpo";
      location.href = "cart.html?app=" + encodeURIComponent(m);
    });
  })();
(function(){
  "use strict";

  function reflect(mode){
    var vpo    = document.getElementById("modeVpo");
    var fillin = document.getElementById("modeFillin");
    var isV = mode === "vpo";
    vpo?.setAttribute("aria-pressed", String(isV));
    fillin?.setAttribute("aria-pressed", String(!isV));
    vpo?.classList.toggle("is-active", isV);
    fillin?.classList.toggle("is-active", !isV);
    try { document.documentElement.setAttribute("data-app", mode); } catch {}
  }

  async function switchModeLive(next){
    if (next !== "vpo" && next !== "fillin") return;

    // 1) persist + expose globals
    try { localStorage.setItem("vanir_app_mode", next); } catch {}
    window.APP_MODE = next;
    if (window.APPS && window.APPS[next]) window.APP = window.APPS[next];

    // 2) update Airtable runtime config
    try { setAirtableRuntimeConfig?.(window.APP.airtable); } catch {}

    // 3) re-gate UI (pure DOM; no network)
    try { gateAppBlocks?.(); gateLabor?.(); applyTitles?.(); } catch {}

    // 4) hydrate dropdowns from cache (no network if cached)
    try {
      const svc = new AirtableService();
      await initDropdowns(svc);     // see section 2; returns early on cache
    } catch (e) {  }

    reflect(next);
  }

  document.getElementById("modeVpo")   ?.addEventListener("click", () => switchModeLive("vpo"),    {passive:true});
  document.getElementById("modeFillin")?.addEventListener("click", () => switchModeLive("fillin"), {passive:true});

  // initial visual state
  reflect((window.APP_MODE || localStorage.getItem("vanir_app_mode") || "vpo").toLowerCase());
})();
 (function(){
  "use strict";

  // Ensure we have a current mode
  var CURRENT = (window.APP_MODE || "vpo");

  // Grab buttons
  var btnVpo    = document.getElementById("modeVpo");
  var btnFillin = document.getElementById("modeFillin");

  if (!btnVpo || !btnFillin) return;

})(); 


(function(){
  "use strict";

  var btn = document.getElementById("cartFab");
  var badge = document.getElementById("cartCountBadge");
  if (!btn) return;

  // Resolve current mode from globals or saved preference
  function getMode(){
    try {
      var m = (window.APP_MODE || localStorage.getItem("vanir_app_mode") || "vpo").toLowerCase();
      return (m === "fillin") ? "fillin" : "vpo";
    } catch { return "vpo"; }
  }

  // Navigate to cart with ?app=mode, and mark this as a mode-aware nav
  function openCart(){
    var mode = getMode();
    try {
      // lets your Google-cache wrapper know this nav is a mode transition
      sessionStorage.setItem("vanir_mode_switch", JSON.stringify({ at: Date.now(), to: mode }));
    } catch {}

    var url = new URL("cart.html", location.href);
    url.searchParams.set("app", mode);
    location.href = url.toString();
  }

  // Click & keyboard activate
  btn.addEventListener("click", function(e){ e.preventDefault(); openCart(); });
  btn.addEventListener("keydown", function(e){
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); openCart(); }
  });

  // Badge: sum of quantities in localStorage cart
function updateCartFabBadge(){
  try {
    var key   = (typeof window.STORAGE_KEY === "string" && window.STORAGE_KEY) || "vanir_cart_v1";
    var saved = JSON.parse(localStorage.getItem(key) || "{}");

    // NEW: prefer saved.cart (current app shape). Fallback to legacy shapes.
    var rows = Array.isArray(saved.cart)     ? saved.cart
             : Array.isArray(saved.items)    ? saved.items
             : Array.isArray(saved.products) ? saved.products
             : [];

    var count = 0;
    for (var i = 0; i < rows.length; i++) {
      var q = Number(rows[i]?.qty ?? rows[i]?.quantity ?? 0);
      if (!Number.isNaN(q)) count += q;
    }

    if (badge) {
      badge.textContent = String(count);
      badge.style.display = count > 0 ? "" : "none";
    }
  } catch (e) {
    if (badge) badge.style.display = "none";
  }
}


  // expose for other code to call after cart changes
  window.updateCartFabBadge = updateCartFabBadge;

  // initial paint
  updateCartFabBadge();
})();
(function(){
  const origHref = Object.getOwnPropertyDescriptor(Location.prototype, 'href').set;
  Object.defineProperty(Location.prototype, 'href', {
    set(v){ console.trace("[BLOCKED] location.href set to:", v); /* comment next line to fully block */ return origHref.call(this, v); }
  });
  const _reload = location.reload;
  location.reload = function(){ console.trace("[BLOCKED] location.reload called"); /* comment next line to fully block */ return _reload.apply(this, arguments); }
})();

(function(){
  "use strict";

  // helpers
  function reflect(mode){
    var isVpo = mode === "vpo";
    document.getElementById("modeVpo")?.setAttribute("aria-pressed", String(isVpo));
    document.getElementById("modeFillin")?.setAttribute("aria-pressed", String(!isVpo));
    document.getElementById("modeVpo")?.classList.toggle("is-active", isVpo);
    document.getElementById("modeFillin")?.classList.toggle("is-active", !isVpo);
  }
  function getMode(){ return (window.APP_MODE || localStorage.getItem("vanir_app_mode") || "vpo").toLowerCase(); }

  async function switchModeLive(nextMode){
    if (nextMode !== "vpo" && nextMode !== "fillin") return;

    // 1) persist + globals
    try { localStorage.setItem("vanir_app_mode", nextMode); } catch {}
    window.APP_MODE = nextMode;
    if (window.APPS && window.APPS[nextMode]) window.APP = window.APPS[nextMode];
    try { document.documentElement.setAttribute("data-app", nextMode); } catch {}

    // 2) re-gate UI (no network)
    try { 
      // these are already in your app (from app-ui-gates.js / inline)
      if (typeof applyTitles === "function") applyTitles();
      if (typeof gateAppBlocks === "function") gateAppBlocks();
      if (typeof gateLabor === "function") gateLabor();
    } catch {}

    // 3) reconfigure Airtable client (so saves go to the right base)
    try { if (typeof setAirtableRuntimeConfig === "function") setAirtableRuntimeConfig(window.APP.airtable); } catch {}

    // 4) rehydrate dropdowns from cache (ATOPTS) or fetch only if missing
    try {
      const svc = new AirtableService();
      if (typeof initDropdowns === "function") {
        await initDropdowns(svc);   // uses session cache; wonâ€™t refetch if cached
      }
    } catch (e) {
      console.warn("rehydrate failed:", e);
    }

    // 5) update the control visual state
    reflect(nextMode);
  }

  // wire the buttons
  document.getElementById("modeVpo")?.addEventListener("click", () => switchModeLive("vpo"),    {passive:true});
  document.getElementById("modeFillin")?.addEventListener("click", () => switchModeLive("fillin"), {passive:true});

  // initial paint
  reflect(getMode());
})();
</script>
<script>
(function(){
  "use strict";

  // -----------------------------------------
  // 0) KILL ANY LEGACY "RELOAD ON MODE" PATHS
  // -----------------------------------------
  // A. Neutralize old helpers that do location.href reloads
  ["__setAppMode", "setModeAndReload", "legacySetMode"].forEach(fn => {
    if (typeof window[fn] === "function") {
      const original = window[fn];
      window[fn] = function(){ console.debug(`[mode] blocked call to ${fn}`); /* no-op */ };
      console.debug(`[mode] ${fn} neutralized (was reloading page)`, original);
    }
  });

  // B. Remove the old <select id="appModeSelect"> if it exists (and any attached onChange)
  (function(){
    const sel = document.getElementById("appModeSelect");
    if (!sel) return;
    const ghost = document.createComment("removed legacy appModeSelect (prevented reload)");
    sel.replaceWith(ghost);
    console.debug("[mode] removed legacy #appModeSelect");
  })();

  // C. Optional: log any navigation attempts so you can spot who tries to reload
  (function installNavTracer(){
    const origSetHref = Object.getOwnPropertyDescriptor(Location.prototype, "href")?.set;
    if (origSetHref) {
      Object.defineProperty(Location.prototype, "href", {
        set(v){
          console.trace("[NAV]", "location.href =", v);
          // Comment-out the next line to *block* navigation during debugging:
          return origSetHref.call(this, v);
        }
      });
    }
    const _reload = location.reload;
   

  })();


  // -----------------------------------------
  // 1) LIVE SWITCH (NO RELOAD, NO GOOGLE TOUCH)
  // -----------------------------------------
  function reflect(mode){
    const isV = (mode === "vpo");
    const btnV = document.getElementById("modeVpo");
    const btnF = document.getElementById("modeFillin");
    btnV?.setAttribute("aria-pressed", String(isV));
    btnF?.setAttribute("aria-pressed", String(!isV));
    btnV?.classList.toggle("is-active", isV);
    btnF?.classList.toggle("is-active", !isV);
    try { document.documentElement.setAttribute("data-app", mode); } catch {}
  }

  function currentMode(){
    try {
      const m = (window.APP_MODE || localStorage.getItem("vanir_app_mode") || "vpo").toLowerCase();
      return (m === "fillin") ? "fillin" : "vpo";
    } catch { return "vpo"; }
  }

  async function switchModeLive(next){
    if (next !== "vpo" && next !== "fillin") return;

    // 1) Persist + expose globals (no navigation)
    try { localStorage.setItem("vanir_app_mode", next); } catch {}
    window.APP_MODE = next;
    if (window.APPS && window.APPS[next]) window.APP = window.APPS[next];

    // 2) Update the URL *without reloading* (optional: keeps ?app= in address bar)
    try {
      const url = new URL(location.href);
      url.searchParams.set("app", next);
      history.replaceState(null, "", url);
    } catch {}

    // 3) Reconfigure Airtable to the new base/table IN MEMORY
    try { setAirtableRuntimeConfig?.(window.APP.airtable); } catch {}

    // 4) Re-gate UI (pure DOM changes; no network)
    try { gateAppBlocks?.(); gateLabor?.(); applyTitles?.(); } catch {}

    // 5) Rehydrate dropdowns from cache (no network if base was cached)
    try {
      const svc = new AirtableService();
      await initDropdowns?.(svc);  // your cache-first version; returns early if cached
    } catch (e) { console.warn("[mode] initDropdowns failed", e); }

    // 6) Keep cart link(s) in sync (no navigation)
    (function syncCartLinks(){
      const mode = next;
      document.querySelectorAll('a[href$="cart.html"], a[data-cart-link]').forEach(a => {
        try {
          const u = new URL(a.getAttribute("href"), location.href);
          u.searchParams.set("app", mode);
          a.setAttribute("href", u.toString());
        } catch {}
      });
    })();

    // 7) Visual state
    reflect(next);
  }

  // -----------------------------------------
  // 2) WIRE THE TWO BUTTONS
  // -----------------------------------------
  document.getElementById("modeVpo")   ?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); switchModeLive("vpo"); },    {passive:true});
  document.getElementById("modeFillin")?.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); switchModeLive("fillin"); }, {passive:true});

  // Initial paint
  reflect(currentMode());
})();
</script>

<script>
(function(){
  "use strict";

  // label per mode
  const TITLES = { vpo: "VPO", fillin: "Fill-In" };

  // set all .page-title elements and the <title> tag
  function setPageTitleForMode(mode){
    const m = (mode || "").toLowerCase();
    const label = TITLES[m] || TITLES.vpo;

    // update any H1s (or other elements) that use .page-title
    document.querySelectorAll(".page-title").forEach(el => { el.textContent = label; });

    // optionally update browser tab title too
    try { document.title = label; } catch {}
  }

  // expose so your switchModeLive can call it
  window.setPageTitleForMode = setPageTitleForMode;

  // initial paint based on current mode
  setPageTitleForMode((window.APP_MODE || localStorage.getItem("vanir_app_mode") || "vpo").toLowerCase());

  // fallback: if you already flip <html data-app="..."> elsewhere, keep H1 in sync
  new MutationObserver(() => {
    const mode = (document.documentElement.getAttribute("data-app") || "vpo").toLowerCase();
    setPageTitleForMode(mode);
  }).observe(document.documentElement, { attributes: true, attributeFilter: ["data-app"] });

  // if you control switchModeLive, also call this inside it:
  // setPageTitleForMode(nextMode);
})();
</script>


</body>
</html>