<!DOCTYPE html>
<html lang="en" data-app="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Your Cart — Product & VPO / Fill-In</title>

  <link rel="stylesheet" href="style.css"/>
  <link rel="stylesheet" href="cart.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
<script src="at-options-cache.js"></script>

  <script src="app-config.js"></script>

</head>
<body>

  <main>
    <header class="cart-header">
      <div class="cart-actions" role="toolbar" aria-label="Cart actions">
        <a href="index.html" class="btn btn--ghost btn--back btn--icon-only" aria-label="Continue browsing">
          <span class="btn__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
              <path d="M15 19l-7-7 7-7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span class="btn__text">Continue Browsing</span>
        </a>

        <h1 class="h2">Your Cart</h1>
        <!-- Button label can be anything; keeping “Clear All” -->
        <button id="clearCart" class="btn danger" aria-label="Clear all items">Clear All</button>
      </div>
    </header>

    <!-- Shared top form card; contents below swap by app mode -->
    <section id="form-section" class="card" aria-labelledby="formTitle">
      <div id="airtableBanner">
        <strong>Missing Airtable API Key.</strong> In your browser console run:
        <code>localStorage.setItem('AIRTABLE_API_KEY','patTGK9HVgF4n1zqK.cbc0a103ecf709818f4cd9a37e18ff5f68c7c17f893085497663b12f2c600054')</code>
      </div>

      <header class="stack" style="margin-bottom: 8px;">
        <strong id="formTitle">Request Details</strong>
      </header>

      <!-- Common fields (both apps) -->
      <div class="field">
        <label class="field-label" for="branchSelect">Branch</label>
        <!-- allow persistence hook if you already use it -->
        <select id="branchSelect" data-persist-key="branch"><option value="">—</option></select>
      </div>

      <div class="grid" role="group" aria-label="Common Fields">
        <div class="field">
          <label class="field-label" for="customerSelect">Customer</label>
          <select id="customerSelect"><option value="">—</option></select>
        </div>

        <div class="field">
          <label class="field-label" for="fieldManagerSelect">Field Manager</label>
          <select id="fieldManagerSelect" data-persist-key="fieldManager">
            <option value="">—</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="jobName">Job Name</label>
          <input id="jobName" type="text" placeholder="Job Name" />
        </div>
      </div>

      <!-- ========================= -->
      <!-- Fill-In only fields       -->
      <!-- ========================= -->
      <div class="grid" data-app-only="fillin" role="group" aria-label="Fill-In Only Fields" style="display:none;">
        <div class="field">
          <label class="field-label" for="neededBySelect">Needed By</label>
          <select id="neededBySelect">
            <option value="" selected>— Select —</option>
            <option value="ASAP">ASAP</option>
            <option value="Tomorrow">Tomorrow</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="planName">Plan Name</label>
          <input id="planName" type="text" placeholder="Plan Name" />
        </div>

        <div class="field">
          <label class="field-label" for="elevation">Elevation</label>
          <input id="elevation" type="text" placeholder="Elevation" />
        </div>

        <div class="field">
          <label class="field-label" for="reasonSelect">Reason For Fill In</label>
          <select id="reasonSelect">
            <option value="" selected>— Select —</option>
            <option value="Takeoff Incorrect">Takeoff Incorrect</option>
            <option value="Theft">Theft</option>
            <option value="Subcontractor Installed Incorrectly">Subcontractor Installed Incorrectly</option>
            <option value="Missing Options">Missing Options</option>
            <option value="Ordered Incorrectly">Ordered Incorrectly</option>
            <option value="Scope Not Followed">Scope Not Followed</option>
            <option value="Damaged">Damaged</option>
            <option value="Scope Has Changed">Scope Has Changed</option>
            <option value="Borrowed Material For Another Job">Borrowed Material For Another Job</option>
            <option value="Warranty Item">Warranty Item</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="pleaseDescribe">Please Describe</label>
          <textarea id="pleaseDescribe" placeholder="Describe the situation"></textarea>
        </div>
      </div>

      <!-- ========================= -->
      <!-- VPO only fields           -->
      <!-- ========================= -->
      <div class="grid" data-app-only="vpo" role="group" aria-label="VPO Only Fields" style="display:none;">
        <div class="field">
          <label class="field-label" for="subcontractorCompanySelect">Subcontractor Company Name</label>
          <select id="subcontractorCompanySelect">
            <option value="">—</option>
          </select>
        </div>

        <div class="field" style="grid-column: 1 / -1;">
          <label class="field-label" for="descriptionOfWork">Description of Work</label>
          <textarea id="descriptionOfWork" rows="5" placeholder="Describe the work to be done"></textarea>
        </div>
      </div>

    
    </section>

    <!-- Cart table (shared) -->
    <section id="cart-section" class="card" aria-labelledby="cartTitle">
      <header class="stack" style="margin-bottom: 8px;">
        <strong id="cartTitle">Selected SKUs</strong>
      </header>

      <table id="cart-table">
        <thead>
          <tr>
            <th>Vendor</th>
            <th>SKU</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Unit (Sell)</th>
            <th>Line Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Labor (shown only when includeLabor===true) -->
      <div id="labor-list" style="display:none;">
        <div class="labor-head" style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px;">
          <strong>Labor</strong>
          <div><button id="addLabor" class="btn">+ Add Labor Line</button></div>
        </div>
      </div>

      <div class="sep"></div>

      <div id="globalMarginWrap">
        <div class="field">
          <label class="field-label" for="globalMarginPct">Material Margin (%)</label>
          <input id="globalMarginPct" type="number" min="0" step="1" value="30" />
        </div>
      </div>

      <div id="totals" aria-live="polite" aria-atomic="true">
        <div class="label" id="productsTotalLabel">Products Total:</div><div class="value" id="productTotal">$0.00</div>
        <div class="label" id="laborTotalLabel">Labor Total:</div>     <div class="value" id="laborTotal">$0.00</div>
        <div class="label grand">Grand Total:</div><div class="value grand" id="grandTotal">$0.00</div>
      </div>
        <div class="right">
        <span id="airtableStatus" class="pill" aria-live="polite" aria-atomic="true">Idle</span>
        <button id="saveAirtable" class="btn primary">Save to Airtable</button>
      </div>
    </section>
  </main>

  <div id="toast" role="status" aria-live="polite" aria-atomic="true" style="display:none;">Done</div>

  <!-- Scripts -->
  <script src="airtable.service.js"></script>
  <script src="cart.js"></script>
  <script src="patch.js"></script>
  <script src="loading-indicators.js"></script>


  <script src="app-ui-gates.js"></script>

  <!-- Tiny runtime toggles for this page -->
  <script>
  (function(){
    "use strict";

    // 1) Title + header label
    function applyTitles(){
      try {
        var app = window.APP || {};
        var title = (app.uiTitle || (app.key === "fillin" ? "Fill-In" : "VPO"));
        document.title = "Cart — " + title;
        var formTitle = document.getElementById("formTitle");
        if (formTitle) formTitle.textContent = title + " Request Details";
      } catch(e){}
    }

    // 2) Show/hide app-specific blocks
    function gateAppBlocks(){
      var appKey = (window.APP && window.APP.key) || "vpo";
      var onlyEls = document.querySelectorAll("[data-app-only]");
      onlyEls.forEach(function(el){
        var want = (el.getAttribute("data-app-only") || "").toLowerCase();
        el.style.display = (want === appKey) ? "" : "none";
      });
    }

    // 3) Labor visibility + totals row toggle
    function gateLabor(){
      var show = !!(window.APP && window.APP.includeLabor);
      var labor = document.getElementById("labor-list");
      var laborLbl = document.getElementById("laborTotalLabel");
      var laborVal = document.getElementById("laborTotal");
      if (labor) labor.style.display = show ? "" : "none";
      if (laborLbl) laborLbl.style.display = show ? "" : "none";
      if (laborVal) laborVal.style.display = show ? "" : "none";
    }

    // 4) Fill-In select options helpers (Needed By / Reason)
    function setNeededByOptions(){
      var el = document.getElementById("neededBySelect");
      if (!el) return;
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(new Option("— Select —", "", true, false));
      ["ASAP","Tomorrow"].forEach(function(v){ el.appendChild(new Option(v, v)); });
    }
    function setReasonOptions(){
      var el = document.getElementById("reasonSelect");
      if (!el) return;
      while (el.firstChild) el.removeChild(el.firstChild);
      el.appendChild(new Option("— Select —", "", true, false));
      [
        "Takeoff Incorrect",
        "Theft",
        "Subcontractor Installed Incorrectly",
        "Missing Options",
        "Ordered Incorrectly",
        "Scope Not Followed",
        "Damaged",
        "Scope Has Changed",
        "Borrowed Material For Another Job",
        "Warranty Item",
        "Other"
      ].forEach(function(v){ el.appendChild(new Option(v, v)); });
    }

    // 5) Persist/restore branch + FM (optional; safe if not used)
    function initPersist(){
      var IDS = { branch: "branchSelect", fm: "fieldManagerSelect" };
      var KEYS = { branchId:"vanir_branch_id", branchLbl:"vanir_branch_label", fmId:"vanir_field_manager_id", fmLbl:"vanir_field_manager_label" };
      function $(id){ return document.getElementById(id); }
      function nonEmpty(s){ return typeof s === "string" && s.trim() !== ""; }
      function trySet(k,v){ try{ localStorage.setItem(k,String(v??"")); }catch(e){} }
      function tryGet(k){ try{ return localStorage.getItem(k)||""; }catch(e){ return ""; } }

      function ensureOption(selectEl, value, label){
        if (!selectEl || !nonEmpty(String(value))) return;
        var exists = Array.prototype.some.call(selectEl.options, function(o){ return o.value === String(value); });
        if (!exists) {
          var opt = document.createElement("option");
          opt.value = String(value);
          opt.textContent = nonEmpty(label) ? String(label) : String(value);
          opt.dataset.restored = "true";
          selectEl.appendChild(opt);
        }
        selectEl.value = String(value);
      }
      function selectByIdOrLabel(selectEl, savedId, savedLabel){
        if (!selectEl) return false;
        if (nonEmpty(savedId)) {
          selectEl.value = savedId;
          if (selectEl.value === savedId) return true;
        }
        if (nonEmpty(savedLabel)) {
          var want = savedLabel.trim().toLowerCase();
          for (var i=0; i<selectEl.options.length; i++){
            var o = selectEl.options[i];
            if ((o.textContent || "").trim().toLowerCase() === want) {
              selectEl.value = o.value;
              return true;
            }
          }
          ensureOption(selectEl, savedId || savedLabel, savedLabel);
          return true;
        }
        return false;
      }
      function whenOptionsReady(selectEl, cb){
        if (!selectEl) return;
        if (selectEl.options && selectEl.options.length > 1) { cb(); return; }
        var done=false;
        var obs = new MutationObserver(function(){
          if (done) return;
          var ok = selectEl.options && selectEl.options.length > 1;
          if (ok){ done=true; try{obs.disconnect();}catch(e){} cb(); }
        });
        try{ obs.observe(selectEl,{childList:true,subtree:false}); }catch(e){}
        setTimeout(function(){
          if (done) return;
          var ok = selectEl.options && selectEl.options.length > 1;
          if (ok){ done=true; try{obs.disconnect();}catch(e){} cb(); }
        },2000);
      }

      function saveBranch(){
        var sel = $(IDS.branch); if (!sel) return;
        var val = sel.value || "";
        var lbl = (sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : "") || "";
        trySet(KEYS.branchId,  val);
        trySet(KEYS.branchLbl, lbl);
      }
      function saveFM(){
        var sel = $(IDS.fm); if (!sel) return;
        var val = sel.value || "";
        var lbl = (sel.selectedOptions && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : "") || "";
        trySet(KEYS.fmId,  val);
        trySet(KEYS.fmLbl, lbl);
      }
      function restoreBranch(){
        var sel = $(IDS.branch); if (!sel) return;
        selectByIdOrLabel(sel, tryGet(KEYS.branchId), tryGet(KEYS.branchLbl));
      }
      function restoreFM(){
        var sel = $(IDS.fm); if (!sel) return;
        selectByIdOrLabel(sel, tryGet(KEYS.fmId), tryGet(KEYS.fmLbl));
      }

      var bSel = $("branchSelect");
      var fmSel = $("fieldManagerSelect");
      if (bSel) whenOptionsReady(bSel, restoreBranch);
      if (fmSel) whenOptionsReady(fmSel, restoreFM);

      if (bSel) bSel.addEventListener("change", saveBranch, { passive:true });
      if (fmSel) fmSel.addEventListener("change", saveFM, { passive:true });

      // last chance restore
      setTimeout(function(){ try{restoreBranch();}catch(e){} try{restoreFM();}catch(e){} }, 3000);
    }

    function init(){
      // Apply page mode
      applyTitles();
      gateAppBlocks();
      gateLabor();

      // Populate Fill-In selects only if Fill-In is active
      if ((window.APP && window.APP.key) === "fillin") {
        setNeededByOptions();
        setReasonOptions();
      }

      // Optional localStorage persistence
      initPersist();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
  </script>

  <script>
// Always include all lines of code
(function () {
  "use strict";

  // ---- IDs used in your page ----
  const BRANCH_SELECT_ID        = "branchSelect";
  const FIELD_MANAGER_SELECT_ID = "fieldManagerSelect";

  // Utility: safe text normalize for comparisons
  function norm(s) {
    return String(s || "").trim().toLowerCase();
  }

  // Utility: pick label per LABEL_CANDIDATES (mirrors your service)
  function pickLabel(fields, labelCandidates) {
    labelCandidates = Array.isArray(labelCandidates) ? labelCandidates : [];
    for (const k of labelCandidates) {
      const val = fields?.[k];
      if (!val) continue;
      if (typeof val === "object" && val && "name" in val) return String(val.name);
      if (typeof val === "string" && val.trim()) return val.trim();
      if (Array.isArray(val) && val.length && typeof val[0] === "string") {
        // if multi-select or array of strings, join first/primary
        return String(val[0]).trim();
      }
    }
    return String(fields?.Name || fields?.name || "").trim() || "";
  }

  // Build <option> list for a <select>
  function populateSelect(select, options, { placeholder = "Select…" } = {}) {
    if (!select) return;
    const prev = select.value;
    select.innerHTML = "";
    const ph = document.createElement("option");
    ph.value = "";
    ph.textContent = placeholder;
    select.appendChild(ph);

    for (const opt of options) {
      const o = document.createElement("option");
      o.value = opt.id;             // record id
      o.textContent = opt.label;    // human label
      select.appendChild(o);
    }

    // Try to restore previous selection if still present
    if (prev && Array.from(select.options).some(o => o.value === prev)) {
      select.value = prev;
    } else {
      select.value = ""; // default to placeholder
    }
    // Fire change for downstream listeners if needed
    try { select.dispatchEvent(new Event("change", { bubbles: true })); } catch {}
  }

  // Fetch *all* Field Managers (once per call) and return raw records
  async function fetchAllManagers() {
    const svc = new AirtableService();
    const src = APP?.airtable?.SOURCES?.FIELD_MANAGER || {};
    // Probe and fetch using curated source (view-aware)
    const recs = await svc.fetchAllFromSource(src.TABLE_ID, src.VIEW_ID);
    return recs || [];
  }

  // Turn records into {id,label} using LABEL_CANDIDATES
  function mapManagersToOptions(records, labelCandidates) {
    const out = [];
    const seen = new Set();
    for (const r of records) {
      const id = r?.id;
      if (!id || seen.has(id)) continue;
      const label = pickLabel(r?.fields, labelCandidates) || id;
      out.push({ id, label, fields: r?.fields || {} });
      seen.add(id);
    }
    // sort by label (case-insensitive)
    out.sort((a,b) => a.label.localeCompare(b.label, undefined, { sensitivity: "base" }));
    return out;
  }

  // Filter by Vanir Office = selected branch label (string compare)
  function filterManagersByBranch(managerOptions, branchLabel) {
    const b = norm(branchLabel);
    if (!b) return managerOptions.slice(); // show all if branch empty
    return managerOptions.filter(m => norm(m.fields?.["Vanir Office"]) === b);
  }

  // Main controller
  async function wireManagerFiltering() {
    const branchSel = document.getElementById(BRANCH_SELECT_ID);
    const mgrSel    = document.getElementById(FIELD_MANAGER_SELECT_ID);
    if (!mgrSel) return; // nothing to do if manager select not on page

    const labelCandidates = (APP && APP.airtable && APP.airtable.SOURCES && APP.airtable.SOURCES.FIELD_MANAGER && APP.airtable.SOURCES.FIELD_MANAGER.LABEL_CANDIDATES) || ["Full Name","Name","Field Manager","Field Manager Name","Title"];

    // Load all managers once
    let allRecords;
    try {
      allRecords = await fetchAllManagers();
    } catch (e) {
      console.error("[managers] fetch failed:", e);
      populateSelect(mgrSel, [], { placeholder: "Failed to load managers" });
      return;
    }

    const allOptions = mapManagersToOptions(allRecords, labelCandidates);

    // Helper to (re)render managers based on current branch label
    function renderForCurrentBranch() {
      const branchLabel = (() => {
        if (!branchSel) return "";
        const opt = branchSel.selectedOptions && branchSel.selectedOptions[0];
        return (opt && opt.textContent) ? opt.textContent.trim() : "";
      })();
      const filtered = filterManagersByBranch(allOptions, branchLabel);
      populateSelect(mgrSel, filtered, { placeholder: "Select Field Manager…" });
    }

    // Initial render (no branch or preselected branch)
    renderForCurrentBranch();

    // React to branch changes (if the branch select exists)
    if (branchSel) {
      branchSel.addEventListener("change", renderForCurrentBranch);
    }
  }

  // Auto-run when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wireManagerFiltering);
  } else {
    wireManagerFiltering();
  }
})();
(function(){
  "use strict";
  var mode = (window.APP_MODE || (window.APP && window.APP.key) || "vpo").toLowerCase();
  var wrap = document.getElementById("globalMarginWrap");
  var inp  = document.getElementById("globalMarginPct");

  if (!wrap || !inp) return;

  if (mode === "vpo") {
    // Force 0% for UX consistency and disable the control
    try { localStorage.setItem("vanir_global_margin_pct", "0"); } catch {}
    inp.value = "0";
    inp.setAttribute("disabled", "disabled");
    wrap.style.display = "none";

    // If your cart has a render/refresh function, call it to recalc totals immediately.
    // (Safe no-op if undefined.)
    try { if (typeof window.renderCart === "function") window.renderCart(); } catch {}
  } else {
    inp.removeAttribute("disabled");
    wrap.style.display = "";
  }
})();
</script>

</body>
</html>
